<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Signature Manager</title>
    
    <!-- Load Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .navbar {
            background-color: #093f64 !important;
            margin-bottom: 30px;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .search-section {
            margin-bottom: 30px;
        }

        .signature-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            background: #fafafa;
        }

        .btn-primary {
            background-color: #4285f4;
            border: none;
            margin: 10px 5px;
        }

        .btn-primary:hover {
            background-color: #357ae8;
        }

        .btn-outline-secondary {
            margin: 10px 5px;
        }

        .alert {
            margin-top: 20px;
        }

        #filter-records {
            margin-top: 20px;
        }

        .signature-preview-container {
            background: white;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <span style="padding-left: 30px">Gmail Signature Manager</span>
            </span>
        </div>
    </nav>

    <!-- Page Content -->
    <div class="container">
        <div class="alert alert-success" id="successAlert" style="display: none;">
            Signature updated successfully! Check your Gmail settings to verify.
        </div>

        <div class="alert alert-danger" id="errorAlert" style="display: none;">
            <span id="errorMessage"></span>
        </div>

        <div class="card mb-4">
            <div class="card-header" style="background-color: #093f64; color: white;">
                <h5>Search for Your Signature</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Enter your name or phone extension to find your signature.</p>
                <div class="search-section">
                    <input class="form-control form-control-lg" id="txt-search" placeholder="Search by name or extension..." />
                </div>
            </div>
        </div>

        <div id="filter-records"></div>
    </div>

    <!-- Load Bootstrap JS and Google API -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        // Configuration - Replace with your Google Cloud Project credentials
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // Replace with your OAuth 2.0 Client ID
        const SCOPES = 'https://www.googleapis.com/auth/gmail.settings.basic https://www.googleapis.com/auth/gmail.settings.sharing';
        
        let tokenClient;
        let accessToken = null;
        let selectedEmail = '';
        let selectedSignatureHTML = '';

        // Employee signature data - Replace with your organization's data
        // This can be loaded from a JSON file or API endpoint
        const employeeData = [
            {
                name: "John Doe",
                title: "Software Engineer",
                email: "john.doe@company.com",
                phone: "5551001",
                extension: "1001",
                fax: "",
                designations: "",
                disclaimer: "<p style='font-size: 10px; color: #666;'>This email contains confidential information and is intended solely for the addressee.</p>"
            },
            {
                name: "Jane Smith",
                title: "Human Resources Manager",
                email: "jane.smith@company.com",
                phone: "5551002",
                extension: "1002",
                fax: "",
                designations: "SHRM-CP",
                disclaimer: "<p style='font-size: 10px; color: #666;'>This email contains confidential information and is intended solely for the addressee.</p>"
            }
            // Add more employee data here
        ];

        // Initialize Google Identity Services
        window.addEventListener('load', () => {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
                showError('Please configure your Google OAuth Client ID. See README for instructions.');
                return;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        showError('Authentication failed: ' + response.error);
                        return;
                    }
                    accessToken = response.access_token;
                    showSuccess('Successfully authenticated! You can now apply your signature.');
                },
            });
        });

        // Format phone numbers
        function formatPhoneNumber(phoneNumberString) {
            const cleaned = ('' + phoneNumberString).replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return '(' + match[1] + ') ' + match[2] + '-' + match[3];
            }
            return phoneNumberString;
        }

        // Generate signature HTML
        function generateSignatureHTML(employee) {
            let signatureHTML = `
                <div style="font-family: Arial, sans-serif; font-size: 14px; color: #333; max-width: 500px;">
                    <table style="border-collapse: collapse;">
                        <tr>
                            <td style="padding-right: 15px;">
                                <div style="font-size: 16px; font-weight: 700; color: #003F68; margin-bottom: 5px;">
                                    ${escapeHtml(employee.name)}${employee.designations ? ' <span style="font-size: 12px; color: #898E91;">' + escapeHtml(employee.designations) + '</span>' : ''}
                                </div>`;
            
            if (employee.title) {
                signatureHTML += `
                                <div style="font-size: 12px; font-weight: 700; color: #898E91; text-transform: uppercase; margin-bottom: 5px;">
                                    ${escapeHtml(employee.title)}
                                </div>`;
            }
            
            signatureHTML += `
                                <div style="font-size: 13px; font-weight: 700; color: #003F68; margin-top: 8px;">`;
            
            if (employee.phone) {
                signatureHTML += `
                                    <div style="margin-bottom: 3px;">
                                        Phone: <span style="font-weight: 400;"><a href="tel:+1${employee.phone}" style="text-decoration: none; color: #003F68;">${formatPhoneNumber(employee.phone)}</a></span>
                                    </div>`;
            }
            
            if (employee.fax) {
                signatureHTML += `
                                    <div style="margin-bottom: 3px;">
                                        Fax: <span style="font-weight: 400;"><a href="tel:+1${employee.fax}" style="text-decoration: none; color: #003F68;">${formatPhoneNumber(employee.fax)}</a></span>
                                    </div>`;
            }
            
            signatureHTML += `
                                    <div style="margin-bottom: 3px;">
                                        Website: <span style="font-weight: 400;"><a href="https://yourcompany.com" style="text-decoration: none; color: #003F68;">yourcompany.com</a></span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                    ${employee.disclaimer || ''}
                </div>`;
            
            return signatureHTML;
        }

        // Authenticate with Google
        function authenticate() {
            if (!tokenClient) {
                showError('Google authentication not initialized. Please refresh the page.');
                return;
            }
            tokenClient.requestAccessToken({ prompt: '' });
        }

        // Apply signature to Gmail
        async function applySignature(employee) {
            if (!accessToken) {
                showError('Please authenticate with Google first by clicking "Step 1: Authenticate"');
                return;
            }

            selectedEmail = employee.email;
            selectedSignatureHTML = generateSignatureHTML(employee);

            try {
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/settings/sendAs/${encodeURIComponent(selectedEmail)}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            signature: selectedSignatureHTML
                        })
                    }
                );

                if (response.ok) {
                    showSuccess('Signature updated successfully! Check your Gmail settings to verify.');
                } else {
                    const error = await response.json();
                    if (response.status === 401) {
                        showError('Authentication expired. Please click "Step 1: Authenticate" again.');
                        accessToken = null;
                    } else if (response.status === 404) {
                        showError('Could not find email address in your Gmail account. Make sure you\'re signed in with the correct Google account.');
                    } else {
                        showError('Failed to update signature: ' + (error.error?.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                showError('Error updating signature: ' + error.message);
            }
        }

        // Search functionality
        document.getElementById('txt-search').addEventListener('keyup', function() {
            const searchField = this.value.trim();
            const filterRecords = document.getElementById('filter-records');
            
            if (searchField === '') {
                filterRecords.innerHTML = '';
                return;
            }

            const regex = new RegExp(searchField, 'i');
            let output = '';

            employeeData.forEach(employee => {
                if (employee.extension.search(regex) !== -1 || employee.name.search(regex) !== -1) {
                    const signatureHTML = generateSignatureHTML(employee);
                    
                    output += `
                        <div class="signature-card">
                            <h5>Found: ${escapeHtml(employee.name)}</h5>
                            <p><strong>Title:</strong> ${escapeHtml(employee.title)}</p>
                            <p><strong>Email:</strong> ${escapeHtml(employee.email)}</p>
                            <p><strong>Extension:</strong> ${escapeHtml(employee.extension)}</p>
                            
                            <div class="signature-preview-container">
                                <strong>Signature Preview:</strong>
                                <div style="margin-top: 10px;">${signatureHTML}</div>
                            </div>
                            
                            <div>
                                <button type="button" class="btn btn-primary btn-lg" onclick="authenticate()">
                                    Step 1: Authenticate with Google
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick='applySignature(${JSON.stringify(employee).replace(/'/g, "&#39;")})'>
                                    Step 2: Apply Signature
                                </button>
                            </div>
                        </div>`;
                }
            });

            if (output === '') {
                output = '<div class="alert alert-info">No results found. Try searching by name or extension.</div>';
            }

            filterRecords.innerHTML = output;
        });

        // Show success message
        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 5000);
            
            // Hide error alert if showing
            document.getElementById('errorAlert').style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            errorAlert.style.display = 'block';
            
            // Hide success alert if showing
            document.getElementById('successAlert').style.display = 'none';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
